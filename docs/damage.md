# アクセスのダメージ計算方法

ダメージの計算には大きく３つの段階があります
- 基本ダメージ
- 固定ダメージ
- 最終的なダメージ

## 基本ダメージの計算

基本ダメージには2種類の値が内部的に存在します
```ts
interface DamageCalcState {
  variable: number
  constant: number
}
```

`variable`の値はアクセスでんこのAPを元に計算される通常のダメージ量で、最終ダメージの計算において固定ダメージによる増減の影響を受けます. 一方で`constant`の値は固定ダメージの影響を受けません. 一部の特殊なスキル`damage_special`でのみ発生します.


#### 通常の計算方法
まず基本ダメージ計算に影響する処理を実行します

- フィルム補正の反映
  - アクセスするでんこが着用するフィルムのATK増減
  - アクセスを受けるでんこが着用するフィルムのDEF増減
  - フィルム未着用の場合は+0％で計算
- スキル`damage_atk, damage_def` 
  - ATK, DEFの増減
  - ATK, DEFを一旦すべて加算し、最後にAPに乗算されます
- スキル`damage_special` 
  - 特殊なダメージ処理を行います
  - ダメージの肩代わりや上書きができます

`damage_atk, damage_def, damage_special`のスキル処理後のタイミングで基本ダメージがまだ計算されていない場合、後述の式で計算した値がセットされます.

#### 特殊なスキル

一部の特殊なスキル`damage_special`では基本ダメージの計算を代行します.
- （例）ミオ：ダメージの肩代わり  
- （例）チコ：相手HPと同量のダメージ量に上書き  

`damage_special`の段階までに基本ダメージが計算済みの場合は固定ダメージの計算までスキップします.

## 基本ダメージの計算式

基本ダメージは次の式で計算します

- AP: アクセスするでんこのAP
- ATK, DEF: 発動した各スキルの値の総和（%）
- damageRatio: アクセス・被アクセスでんこの属性による補正値（1.0 または 1.3）

```js
damageBase = {
    value: max(
        AP * (100 + ATK - DEF)/100.0 * (damageRatio),
        1,
    ),
    constant: 0
}
```

**注意**
- ATK, DEFの総和が0%を下回っても基本ダメージ量は負数にはなりません, 最低でも1のダメージが発生します
- `damageBase.value`の値は小数点以下を切り捨てます
- `damageBase.value`の値は必ず正数（１以上の整数）になります（`constant`は負数も許容）

## 固定ダメージの計算

スキル`damage_fixed`を処理し、発動したスキルの固定ダメージ量の総和を計算します: `damageFixed`

**注意**
負数の固定ダメージ＝回復もあります  

## 最終ダメージの計算
基本ダメージと固定ダメージを合算します

- 基本ダメージと固定ダメージを加算します
  - 固定ダメージの影響を受ける`damageBase.variable`のみ加算します
  - 固定ダメージの軽減でもダメージ量は負数にはなりません
- 固定ダメージの影響受けない分の基本ダメージを加算します

```js
damage = max(
    damageBase.variable + damageFixed,
    0
) + damageBase.constant
```