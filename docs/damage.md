# アクセスのダメージ計算方法

ダメージの計算には大きく３つの段階があります
- 基本ダメージ
- 固定ダメージ
- 最終的なダメージ

## 基本ダメージの計算

基本ダメージには2種類の値が内部的に存在します
```ts
interface DamageCalcState {
  variable: number
  constant: number
}
```

`variable`の値は基本的に、後に説明する計算式で導出される基本ダメージの値で、最終ダメージの計算において固定ダメージによる増減の影響を受けます. 一方で`constant`の値は固定ダメージの影響を受けません. 一部の特殊なスキル`damage_special`でのみ発生します.

まず基本ダメージ計算に影響するスキルを処理します

- `damage_common` ATK, DEFの増減
  - ATK, DEFを一旦すべて加算し、最後にAPに乗算されます
- `damage_special` 特殊なダメージ処理
  - ダメージの肩代わりや上書きができます

**注意**
一部の特殊なスキル`damage_special`が発動した影響で、この時点で基本ダメージがスキルにより計算＆設定済みの場合があります. 計算済みの場合は固定ダメージの計算までスキップします.

まだ計算されていない場合は基本ダメージを次の式で計算します

- AP: アクセスするでんこのAP
- ATK, DEF: `damage_common`で発動した各スキルの値の総和（%）
- damageRatio: アクセス・被アクセスでんこの属性による補正値（1.0 または 1.3）

```js
damageBase = {
    value: max(
        AP * (100 + ATK - DEF)/100.0 * (damageRatio),
        1,
    ),
    constant: 0
}
```

**注意**
- ATK, DEFの総和が0%を下回っても基本ダメージ量は負数にはなりません, 最低でも1のダメージが発生します
- `damageBase.value`の値は小数点以下を切り捨てます
- `damageBase.value`の値は必ず正数（１以上の整数）になります（`constant`は負数も許容）

## 固定ダメージの計算

スキル`damage_fixed`を処理し、発動したスキルの固定ダメージ量の総和を計算します: `damageFixed`

**注意**
負数の固定ダメージ＝回復もあります  

## 最終ダメージの計算
基本ダメージと固定ダメージを合算します

- 基本ダメージと固定ダメージを加算します
  - 固定ダメージの影響を受ける`damageBase.variable`のみ加算します
  - 固定ダメージの軽減でもダメージ量は負数にはなりません
- 固定ダメージの影響受けない分の基本ダメージを加算します

```js
damage = max(
    damageBase.variable + damageFixed,
    0
) + damageBase.constant
```