# アクセス処理

ここで言及するコールバック関数はすべてスキルの処理を担う`SkillLogic`に定義されたものです.  

## Overview
すべてのアクセス処理は関数`startAccess`から開始します


アクセス処理中はスキルのコールバック関数`triggerOnAccess`が各段階で呼ばれ、  
段階の種類は`AccessSkillStep`の通りです.

```ts
type AccessSkillStep =
  "pink_check" |
  "probability_check" |
  "before_access" |
  "start_access" |
  "damage_common" |
  "damage_special" |
  "damage_fixed" |
  "after_damage"
```

下にアクセス処理概要のフローチャートを示します
<img src="https://user-images.githubusercontent.com/25225028/201469982-9e5ffe91-23a3-47e2-9435-dede0f8d828d.png" width="300">


#### 1. アクセスの準備処理

  相手不在の確認やフットバース使用状態を確認します.  
  相手をフットバースするタイプのスキルを処理します.  

  発動するスキル：`pink_check`

#### 2. アクセスの開始処理  
  アクセスによるスコア・経験値の加算や、
  相手の不在に関わらず発動するタイプのスキルを処理します.  

発動するスキル：`probability_check, before_access, start_access`

#### 3. ダメージ計算  
  アクセスするでんこのAPを基に、スキルの効果を反映しながらダメージ量を計算します.  

  発動するスキル：`damage_common, damage_special, damage_fixed`

#### 4. ダメージ計算後の処理
スキルにはダメージ量が決定しないと発動を判定できないタイプが一部存在します.  

発動するスキル：`after_damage`

#### 5. アクセス結果の確定
ダメージ計算・スキル効果すべてを考慮して最終的な結果を計算します.  

#### 6. アクセス終了後の処理
アクセスの終了を通達するコールバック関数`onAccessComplete`を呼び出します.   
一部のスキルはアクセス終了のタイミングで発動します.

（例）セリアのスキルはアクセス終了直後に発動


## アクセスの準備・開始処理

Overviewで説明した２つのStepを詳説します

1. アクセスの準備処理
2. アクセスの開始処理

<img src="https://user-images.githubusercontent.com/25225028/201469910-5beef1bc-260f-4177-a7ed-c13a768afda0.png" width="500">

フローチャートの順に、

- 相手の不在を確認  
  - 不在の場合はフットバースは発動しないため、後続の準備処理はスキップします.
- フットバース（アイテム）の使用を確認
  - アイテムを使用する場合はスキルによるフットバースは発動しません.
- 相手をフットバーすスキル`pink_check`を処理  
  - スキルが発動するとアイテム不使用でも相手をフットバーします.
- スコア・経験値を加算  
  - アクセスによるスコア・経験値は相手が不在でも、フットバース状態でも加算されます.  
  - 相手に与えたダメージ量やリンク成功によるスコア・経験値とは異なります.
- 他スキルの発動確率をブーストするスキル`probability_check`を処理  
  - 他スキルに影響するため最初に発動します.  
- アクセス開始前のスキル`before_access`を処理
  - 基本的に他スキルを無効化するスキルがここで発動します
  - 同じ`before_access`の段階で発動するスキルの無効化は互いに影響しません、すべての無効化スキルが発動します
- アクセス開始時のスキル`start_access`を処理  
  - アクセス結果に関わらず経験値を配布するスキルなどが発動します
  - この段階以降は`before_access`の影響（スキル無効化）を受けます

## ダメージ計算以降の処理


Overviewで説明した３つのStepを詳説します

3. ダメージ計算
4. ダメージ計算後の処理
5. アクセス結果の確定

<img src="https://user-images.githubusercontent.com/25225028/202895210-55ce0f06-83c8-4f1d-92d0-5c4ba0db577a.png" width="800">

#### ダメージ計算の方法
ダメージ計算に関わるスキル処理を行いながらダメージを計算し、でんこのHPとリブートの有無を決定します.

[ダメージ計算の詳細は別ページを参照してください](./damage.md)


#### ダメージ計算後の処理

一部のスキル`after_damage`はダメージ量やリブートの有無に依存するため、ダメージ計算が終了するまで処理できません. 一部のスキルではカウンターや追加アクセスを行うものがあります. 追加ダメージ計算の処理は順に、

- ダメージ計算に影響する状態を初期化する
  - ATK, DEFの総和 => 0%
  - 固定ダメージの総和 => 0
  - 特殊なスキル`damage_special`によって計算された基本ダメージ => `undefined`
- （カウンターのみ）攻守のでんこを入れ替える
- ダメージ計算の処理を再度実行
- （カウンターのみ）攻守のでんこを元に入れ替える
- 追加で計算されたダメージを元の値に加算する
- 追加計算の呼び出し元に戻る

スキル`after_damage`はダメージ量やリブートの有無に依存しますが、スキル`after_damage`自身が編成内のでんこのダメージ量を変化させる場合があります. あるスキルがダメージ計算終了時点では発動の条件を満たさなかったが、別のスキルが発動した影響で発動条件が満たされる、という状況が発生し得ます. このとき、スキル処理の順番によっては正しく発動しないおそれがあるため、必要に応じてスキル処理を繰り返します.

#### アクセス処理の終了
ダメージ計算・すべてのスキル処理が終了したら最終的なアクセスの結果を確定します. 

- 編成内の全でんこのダメージ・HP
  - ダメージ量
  - アクセスによる最終的なHP (>=0)
  - リブートの有無
  - アクセス終了後のHP（リブートする場合は最大HPに戻るため必ず１以上の整数です）
- アクセス側のリンク成功の可否
- 被アクセス側のリンク解除の有無

またスコア・経験値の加算も行われます. 経験値の追加によりレベルアップが発生する場合もここで処理されます.

- （アクセス側のみ）与えたダメージ量に応じたスコア・経験値
- （アクセス側のみ）リンク成功によるスコア・経験値


最後にコールバックを呼び出しアクセスは終了です.

- （リブートした場合のみ）`onDencoReboot`
- `onAccessComplete`